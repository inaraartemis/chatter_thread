<!DOCTYPE html>
<html>

<head>
    <title>Thread - Login</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body class="center">

    <div class="login-box">
        <h2>Thread</h2>
        <p>Join the conversation</p>

        <div id="recent-logins" style="margin-bottom: 20px; display: none;"></div>

        <div style="margin-bottom: 10px; color: var(--text-secondary); font-size: 13px;">Choose your avatar</div>
        <div class="avatar-grid" id="avatar-grid">
            <!-- Emulated by JS below -->
        </div>
        <input type="hidden" id="selected-avatar" value="ðŸ‘¤">

        <input id="username" placeholder="Enter your username" autocomplete="off">
        <button onclick="login()">Enter Thread</button>
    </div>

    <script>
        const avatars = ["ðŸ¦Š", "ðŸ¼", "ðŸ¦", "ðŸ°", "ðŸ¸", "ðŸ¯", "ðŸ™", "ðŸ¦„", "ðŸ‘½", "ðŸ¤–"];
        const grid = document.getElementById("avatar-grid");
        const hiddenInput = document.getElementById("selected-avatar");
        let selectedEl = null;

        // Load Users from Server
        // Cold Start / Inactivity Handling
        const API_URL = "https://YOUR-RENDER-URL.onrender.com/api/users";
        const STATUS_MSG = document.createElement("div");
        STATUS_MSG.style.cssText = "margin-bottom: 20px; color: var(--accent); font-size: 14px; display: none;";
        STATUS_MSG.innerText = "Waking up server... (this may take up to 60s)";

        const loginBox = document.querySelector(".login-box");
        loginBox.insertBefore(STATUS_MSG, loginBox.children[2]); // Insert after title/subtitle

        let startTime = Date.now();
        let notified = false;

        function fetchUsers() {
            fetch(API_URL)
                .then(res => res.json())
                .then(data => {
                    STATUS_MSG.style.display = "none";
                    renderUsers(data.users);
                })
                .catch(err => {
                    const elapsed = (Date.now() - startTime) / 1000;

                    // Rule: Report waking up if delayed (e.g., > 2s)
                    if (elapsed > 2 && !notified) {
                        STATUS_MSG.style.display = "block";
                        notified = true;
                    }

                    // Rule: No errors for first 60s
                    if (elapsed < 60) {
                        // Silent retry
                        setTimeout(fetchUsers, 2000);
                    } else {
                        STATUS_MSG.style.color = "#f15c6d";
                        STATUS_MSG.innerText = "Server unreachable. Please try again later.";
                        console.error("Error fetching users:", err);
                    }
                });
        }

        fetchUsers();

        function renderUsers(users) {
            const container = document.getElementById("recent-logins");
            if (!container) return;

            if (users.length > 0) {
                let html = '<div style="margin-bottom:10px; color:var(--text-secondary); font-size:13px;">Existing Accounts</div><div class="recent-grid">';
                users.forEach(u => {
                    html += `
                        <div class="recent-card" onclick="quickLogin('${u.username}', '${u.avatar}')">
                            <div class="recent-avatar">${u.avatar}</div>
                            <div class="recent-name">${u.username}</div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
                container.style.display = "block";
            } else {
                container.style.display = "none";
            }
        }

        // Render avatars
        avatars.forEach((av, index) => {
            const el = document.createElement("div");
            el.className = "avatar-option";
            el.innerText = av;

            // Auto select first one
            if (index === 0) {
                el.classList.add("selected");
                selectedEl = el;
                hiddenInput.value = av;
            }

            el.onclick = () => {
                if (selectedEl) selectedEl.classList.remove("selected");
                el.classList.add("selected");
                selectedEl = el;
                hiddenInput.value = av;
            };
            grid.appendChild(el);
        });

        function login() {
            const u = document.getElementById("username").value.trim();
            const avatar = hiddenInput.value;

            if (!u) {
                alert("Please enter a username");
                return;
            }
            performLogin(u, avatar);
        }

        function performLogin(u, avatar) {
            // Perform Login

            // Persistence Hack: We want to clear "session" data from previous tests
            // but keep our "Recent Users".
            localStorage.removeItem("username");
            localStorage.removeItem("avatar");

            sessionStorage.setItem("username", u);
            sessionStorage.setItem("avatar", avatar);
            window.location.href = "chat.html";
        }

        function quickLogin(u, avatar) {
            performLogin(u, avatar);
        }


        // Init

        // Enter key support
        document.getElementById("username").addEventListener("keypress", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                login();
            }
        });
    </script>

</body>

</html>